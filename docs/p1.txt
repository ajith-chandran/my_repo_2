Below is a **complete production-grade approach** to:

âœ” Dockerizing your **GraphQL Mesh Gateway**
âœ” Designing a **secure & optimized Dockerfile**
âœ” Structuring your project for **AKS (Azure Kubernetes Service)**
âœ” Providing **AKS-ready manifests**, including Secrets, ConfigMaps, Deployment, Service, HPA
âœ” Explaining CI/CD integration for AKS deployment

This is a full end-to-end solution.

---

# ğŸš€ 1. **Production Directory Structure (Recommended)**

```
mesh-gateway/
 â”œâ”€â”€ .mesh/                 # Mesh artifacts (generated)
 â”œâ”€â”€ src/
 â”‚    â”œâ”€â”€ server.js         # Node mesh HTTP server + auth
 â”‚    â”œâ”€â”€ index.js
 â”œâ”€â”€ mesh.yaml
 â”œâ”€â”€ package.json
 â”œâ”€â”€ Dockerfile
 â”œâ”€â”€ k8s/
 â”‚    â”œâ”€â”€ deployment.yaml
 â”‚    â”œâ”€â”€ service.yaml
 â”‚    â”œâ”€â”€ configmap.yaml
 â”‚    â”œâ”€â”€ ingress.yaml
 â”‚    â”œâ”€â”€ secrets.yaml
 â”œâ”€â”€ .dockerignore
 â””â”€â”€ README.md
```

---

# ğŸš€ 2. **Production-Ready Dockerfile (Azure Optimized)**

This version is:

* Small (uses node:20-alpine)
* Secure (non-root user)
* Cache-optimized
* Ready for Kubernetes / AKS
* Builds Mesh artifacts inside container

### **Dockerfile**

```Dockerfile
# ----------------------------------------
# Stage 1: Builder
# ----------------------------------------
FROM node:20-alpine AS builder

WORKDIR /app

# Install dependencies first for caching
COPY package*.json ./
RUN npm ci

# Copy rest of the code
COPY . .

# Build mesh artifacts
RUN npm run mesh:build

# ----------------------------------------
# Stage 2: Runner
# ----------------------------------------
FROM node:20-alpine

WORKDIR /app

# Create non-root user
RUN addgroup -S mesh && adduser -S mesh -G mesh

# Copy only what is needed
COPY --from=builder /app /app

# Remove dev deps for better security
RUN npm prune --production

USER mesh

EXPOSE 4000

CMD ["node", "src/server.js"]
```

---

# ğŸš€ 3. **Essential .dockerignore**

```
node_modules
npm-debug.log
Dockerfile
.git
.gitignore
azure-pipelines.yml
docs
.env
```

---

# ğŸš€ 4. **Build & Run Locally**

```
docker build -t myorg/mesh-gateway:1.0 .
docker run -p 4000:4000 \
  -e MESH_MAIN_TOKEN=my-main-token \
  -e USER_SERVICE_TOKEN=abc123 \
  myorg/mesh-gateway:1.0
```

It should now run inside Docker.

---

# ğŸš€ 5. **Deploying Docker Image to AKS (Azure Kubernetes)**

You push the image to **Azure Container Registry (ACR)**:

### 1. Login to Azure

```
az login
```

### 2. Create ACR (if not created)

```
az acr create --resource-group my-rg --name myacr123 --sku Basic
```

### 3. Build & Push image to ACR

```
az acr build --registry myacr123 --image mesh-gateway:1.0 .
```

---

# ğŸš€ 6. **AKS CONFIGURATION (FULL MANIFESTS)**

Below are **production-ready manifests**.

---

## ğŸ”¹ 6.1 Kubernetes Secret (store tokens)

### `k8s/secrets.yaml`

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mesh-secrets
type: Opaque
stringData:
  MESH_MAIN_TOKEN: "prod-main-token"
  USER_SERVICE_TOKEN: "prod-user-token"
  ORDER_SERVICE_TOKEN: "prod-order-token"
  INVENTORY_SERVICE_TOKEN: "prod-inventory-token"
```

Note:
âœ” You will override this in CI/CD from Azure KeyVault.

---

## ğŸ”¹ 6.2 ConfigMap (URLs, non-sensitive)

### `k8s/configmap.yaml`

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mesh-config
data:
  USER_SERVICE_URL: "https://users.prod/api"
  ORDER_SERVICE_URL: "https://orders.prod/api"
  INVENTORY_SERVICE_URL: "https://inventory.prod/api"
```

---

## ğŸ”¹ 6.3 AKS Deployment (production-ready)

### `k8s/deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mesh-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mesh-gateway
  template:
    metadata:
      labels:
        app: mesh-gateway
    spec:
      containers:
      - name: mesh-gateway
        image: myacr123.azurecr.io/mesh-gateway:1.0
        env:
        - name: PORT
          value: "4000"
        - name: MESH_MAIN_TOKEN
          valueFrom:
            secretKeyRef:
              name: mesh-secrets
              key: MESH_MAIN_TOKEN
        - name: USER_SERVICE_TOKEN
          valueFrom:
            secretKeyRef:
              name: mesh-secrets
              key: USER_SERVICE_TOKEN
        - name: ORDER_SERVICE_TOKEN
          valueFrom:
            secretKeyRef:
              name: mesh-secrets
              key: ORDER_SERVICE_TOKEN
        - name: INVENTORY_SERVICE_TOKEN
          valueFrom:
            secretKeyRef:
              name: mesh-secrets
              key: INVENTORY_SERVICE_TOKEN
        - name: USER_SERVICE_URL
          valueFrom:
            configMapKeyRef:
              name: mesh-config
              key: USER_SERVICE_URL
        - name: ORDER_SERVICE_URL
          valueFrom:
            configMapKeyRef:
              name: mesh-config
              key: ORDER_SERVICE_URL
        - name: INVENTORY_SERVICE_URL
          valueFrom:
            configMapKeyRef:
              name: mesh-config
              key: INVENTORY_SERVICE_URL
        ports:
        - containerPort: 4000
        resources:
          limits:
            memory: "1Gi"
            cpu: "500m"
          requests:
            memory: "512Mi"
            cpu: "250m"
```

---

## ğŸ”¹ 6.4 AKS Service (exposing Mesh to the cluster)

### `k8s/service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mesh-gateway
spec:
  type: ClusterIP
  selector:
    app: mesh-gateway
  ports:
    - port: 80
      targetPort: 4000
```

---

## ğŸ”¹ 6.5 Ingress (exposing Mesh to Internet)

### `k8s/ingress.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mesh-gateway-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    - host: mesh.mycompany.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: mesh-gateway
                port:
                  number: 80
```

You will attach TLS certs via Azure Application Gateway or Cert Manager.

---

# ğŸš€ 7. **Horizontal Autoscaling (optional but recommended)**

### `k8s/hpa.yaml`

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: mesh-gateway-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: mesh-gateway
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
```

---

# ğŸš€ 8. CI/CD (GitHub Actions â†’ Azure AKS)

### Push code â†’ Build Docker â†’ Push ACR â†’ Deploy to AKS

---

### `.github/workflows/aks-deploy.yml`

```yaml
name: Deploy Mesh Gateway to AKS

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Build
        run: |
          az acr build \
            --registry myacr123 \
            --image mesh-gateway:${{ github.sha }} .

      - name: Get AKS Credentials
        run: |
          az aks get-credentials --resource-group my-rg --name my-aks

      - name: Deploy to AKS
        run: |
          kubectl set image deployment/mesh-gateway mesh-gateway=myacr123.azurecr.io/mesh-gateway:${{ github.sha }}
          kubectl rollout status deployment/mesh-gateway
```

---

# ğŸ¯ 9. Summary â€” Production Flow

| Step                 | Description                          |
| -------------------- | ------------------------------------ |
| Build Mesh artifacts | `npm run mesh:build` inside Docker   |
| Containerize         | Secure Dockerfile with non-root user |
| Push to ACR          | Azure CLI or CI/CD                   |
| Deploy to AKS        | Use K8s manifests                    |
| Provide secrets      | Kubernetes Secrets + Azure KeyVault  |
| Configure URLs       | ConfigMaps                           |
| Autoscale            | HPA                                  |
| Expose externally    | Ingress + TLS                        |

---

# ğŸ 10. Need More?

I can also generate:

âœ… Helm Chart for Mesh
âœ… Fully automated Azure KeyVault integration
âœ… Azure DevOps pipeline instead of GitHub Actions
âœ… Multi-environment (dev/stage/prod) deployment strategy
âœ… Service Mesh integration (Istio, Linkerd, AGIC)
âœ… Logging (Azure Monitor) + Tracing  (OpenTelemetry)

Just tell me what you'd like next.
